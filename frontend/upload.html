<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Start Upload</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <div class="upload-page">
        <section class="form-section">
            <h2 class="section-title">GET STARTED</h2>
            <p class="section-description">Begin your journey with Genetic Algorithms. Follow our simple steps to set up, run your first experiment, and explore how optimization can solve complex challenges.</p>

            <form class="form-container" id="uploadForm">
                <label for="data-file">Upload Data File:</label>
                <div class="file-drop-area" id="fileDropArea">
                    <input type="file" id="data-file" name="data-file"
                                accept=".csv, text/csv"
                                data-required="true">
                    <div class="file-placeholder">
                        <div class="upload-icon"></div>
                        <span id="filePlaceholderText">Upload file (CSV only)</span>
                    </div>
                </div>

                <div class="link-input-container">
                    <label for="dataset-link" style="margin-top: 20px; font-weight: 500;">OR add a link:</label>
                    <input type="url" id="dataset-link" name="dataset-link" placeholder="Paste direct Dataset URL here" class="input-text-field">
                </div>

                <label for="target-column">Choose target column name:</label>
                <select id="target-column" name="target-column" required disabled class="select-dropdown">
                    <option value="" disabled selected>Upload file or add link first to see columns</option>
                </select>
                
                <button type="submit" class="primary-btn wide-btn" id="findFeaturesBtn">
                    Find Features
                </button>
                
                <div class="generate-random-container">
                    <p class="section-description generate-description">Don't have a file ? generate one</p>
                    <button type="button" class="primary-btn wide-btn" id="generateRandomBtn">
                        Generate Random
                    </button>
                </div>

                <a href="#" class="help-link" id="helpLink">Don't Know How to Start? click here</a>
            </form>
        </section>
    </div>

    <div class="site-footer">
        <div class="footer-content-wrapper">
            <div class="footer-logo-section">
                <img src="dna_logo.png" alt="Genetic Algorithm Logo" class="footer-dna-logo">
                <div class="footer-logo-text">Genetic Algorithm</div>
            </div>
            <div class="footer-info-section">
                <div class="footer-column">
                    <p><strong>Location:</strong></p>
                    <p>Damascus, Syria</p>
                </div>
                <div class="footer-column">
                    <p><strong>University:</strong></p>
                    <p>Syrian Virtual University</p>
                </div>
                <div class="footer-column">
                    <p><strong>Subject:</strong></p>
                    <p>intelligent algorithms</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const form = document.getElementById('uploadForm');
        const fileInput = document.getElementById('data-file');
        const linkInput = document.getElementById('dataset-link'); 
        const targetSelect = document.getElementById('target-column');
        const findFeaturesBtn = document.getElementById('findFeaturesBtn');
        const generateRandomBtn = document.getElementById('generateRandomBtn');
        const placeholderText = document.getElementById('filePlaceholderText');
        const dropArea = document.getElementById('fileDropArea');
        const helpLink = document.getElementById('helpLink');
        
        let linkTypingTimer;
        const LINK_DELAY = 1000;

        function displayColumns(columns) {
            targetSelect.innerHTML = '';
            
            if (columns && columns.length > 0) {
                columns.forEach(col => {
                    const option = document.createElement('option');
                    option.value = col;
                    option.textContent = col;
                    targetSelect.appendChild(option);
                });
                targetSelect.disabled = false;
                targetSelect.value = columns[0]; 
            } else {
                targetSelect.innerHTML = '<option value="" disabled selected>No columns found or file is empty</option>';
                targetSelect.disabled = true;
            }
        }

        function setColumnLoadingState(isLoading, message = 'Loading columns...') {
            targetSelect.disabled = isLoading;
            if (isLoading) {
                 targetSelect.innerHTML = `<option value="" disabled selected>${message}</option>`;
            } else if (targetSelect.options.length === 0) {
                 targetSelect.innerHTML = '<option value="" disabled selected>Upload file or add link first to see columns</option>';
            }
        }


        async function fetchAndPopulateFileColumns(file) {
            setColumnLoadingState(true);
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/get_columns', {
                    method: 'POST',
                    body: formData,
                });
                const data = await response.json();

                if (response.ok) {
                    displayColumns(data.columns);
                } else {
                    alert("Error reading columns from file: " + (data.error || "An unknown error occurred."));
                    setColumnLoadingState(false, "Error loading columns");
                }
            } catch (error) {
                console.error('Network error while fetching columns:', error);
                alert('A network error occurred while fetching columns.');
                setColumnLoadingState(false, "Network Error");
            }
        }
        

        async function fetchAndPopulateLinkColumns(link) {
            setColumnLoadingState(true);
            const formData = new FormData();
            formData.append('link', link);

            try {
                const response = await fetch('/get_link_columns', {
                    method: 'POST',
                    body: formData,
                });
                const data = await response.json();

                if (response.ok) {
                    displayColumns(data.columns);
                } else {
                    alert("Error reading columns from link: " + (data.error || "An unknown error occurred."));
                    setColumnLoadingState(false, "Error loading link columns");
                }
            } catch (error) {
                console.error('Network error while fetching link columns:', error);
                alert('A network error occurred while fetching link columns.');
                setColumnLoadingState(false, "Network Error");
            }
        }


        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                dropArea.classList.add('file-loaded');
                placeholderText.textContent = this.files[0].name;
                linkInput.value = ''; 
                fetchAndPopulateFileColumns(this.files[0]);
            } else {
                dropArea.classList.remove('file-loaded');
                placeholderText.textContent = 'Upload file (CSV only)';
                if (linkInput.value === '') {
                    setColumnLoadingState(false, "Upload file or add link first to see columns");
                }
            }
        });

        linkInput.addEventListener('input', function() {
            clearTimeout(linkTypingTimer);
            const linkValue = this.value.trim();

            if (linkValue !== '') {
                fileInput.value = null; 
                dropArea.classList.remove('file-loaded');
                placeholderText.textContent = 'Upload file (CSV only)';

                setColumnLoadingState(true, "Checking link and fetching columns...");

                linkTypingTimer = setTimeout(() => {
                    fetchAndPopulateLinkColumns(linkValue);
                }, LINK_DELAY);

            } else if (fileInput.files.length === 0) {
                setColumnLoadingState(false, "Upload file or add link first to see columns");
            }
        });
        

        function setLoading(isLoading, isRandom = false) {
            const btnToControl = isRandom ? generateRandomBtn : findFeaturesBtn;
            const otherBtn = isRandom ? findFeaturesBtn : generateRandomBtn;

            btnToControl.disabled = isLoading;
            otherBtn.disabled = isLoading;
            
            fileInput.disabled = isLoading;
            linkInput.disabled = isLoading; 

            if (!isRandom) {
                targetSelect.disabled = isLoading || targetSelect.options.length === 0;
            } else {
                targetSelect.disabled = isLoading;
            }

            dropArea.style.pointerEvents = isLoading ? 'none' : 'auto';

            if (isLoading) {
                btnToControl.innerHTML = '<span class="spinner"></span> Running Algorithms...';
            } else {
                findFeaturesBtn.innerHTML = 'Find Features';
                generateRandomBtn.innerHTML = 'Generate Random';
                if (targetSelect.options.length > 0 && targetSelect.options[0].value !== "") {
                    targetSelect.disabled = false;
                }
            }
        }

        async function runFeatureSelection(isRandom = false) {
            let apiEndpoint = '';
            let method = '';
            let body = null;
            let urlParams = '';
            const targetColumn = targetSelect.value;
            
            if (isRandom) {
                apiEndpoint = '/run_ga_direct';
                method = 'GET';
                setLoading(true, true);
                urlParams = '&generated=true'; 

            } else {
                if (!targetColumn) {
                    alert("Please choose a target column.");
                    return;
                }

                if (fileInput.files.length > 0) {
                    apiEndpoint = '/upload'; 
                    method = 'POST';
                    body = new FormData();
                    body.append('file', fileInput.files[0]);
                    body.append('target', targetColumn);
                    setLoading(true, false);
                } else if (linkInput.value.trim() !== '') {
                    const linkValue = encodeURIComponent(linkInput.value.trim());
                    const targetValue = encodeURIComponent(targetColumn);
                    
                    apiEndpoint = '/read_from_link';
                    method = 'POST'; 
                    body = `link=${linkValue}&target=${targetValue}`;
                    
                    setLoading(true, false);
                } else {
                    alert("Please upload a dataset file, add a link, or generate a random one.");
                    return;
                }
            }
            
            try {
                const fetchOptions = {
                    method: method,
                    body: body instanceof FormData ? body : body,
                };
                
                if (apiEndpoint === '/read_from_link') {
                    fetchOptions.headers = {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    };
                }
                
                const response = await fetch(apiEndpoint, fetchOptions);

                const rawData = await response.text();
                let data;
                
                try {
                    data = JSON.parse(rawData);
                } catch (e) {
                    throw new Error(`Invalid JSON response from server. Raw data: ${rawData.substring(0, 100)}...`);
                }

                if (response.ok) {
                    if (Array.isArray(data) && data.length >= 4) {
                        const encodedData = encodeURIComponent(JSON.stringify(data));
                        window.parent.loadPage('output.html?results=' + encodedData + urlParams); 
                    } else {
                        throw new Error("Server returned incomplete or invalid results array (Expected >= 4 items).");
                    }
                } else {
                    if (data.availableColumns) {
                        const availableCols = data.availableColumns.join(', ');
                         alert(`Error: ${data.error}. Available columns are: ${availableCols}`);
                    } else {
                        alert("Error from server: " + (data.error || "An unknown server error occurred."));
                    }
                }
            } catch (error) {
                console.error('Network or processing error:', error);
                alert(`A critical error occurred: ${error.message}. Please check the server status.`);
            } finally {
                setLoading(false, isRandom);
            }
        }


        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            await runFeatureSelection(false); 
        });
        
        generateRandomBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            await runFeatureSelection(true);
        });

        helpLink.addEventListener('click', function(e) {
            e.preventDefault();
            if (window.parent.loadAndScroll) {
                window.parent.loadAndScroll('home.html', '#user-guide');
            } else {
                window.parent.loadPage('home.html');
            }
        });
        
        setColumnLoadingState(false, "Upload file or add link first to see columns");

    </script>
</body>
</html>
